<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DanmakuHost</title>
</head>
<body style="user-select: none;">
    status: <span id="status"></span><br>
    font-size: <input type="number" id="font-size" value="40" style="width: 50px;" onchange="updateSetting()"> px<br>
    duration: <input type="number" id="duration" value="40" style="width: 50px;" onchange="updateSetting()"> sec<br>
    colors: <br>
    <input type="text" id="colors" value="" style="display: block; width: 100%;" onchange="updateSetting()">
    secret: <br>
    <input type="password" id="secret" style="display: block; width: 100%;" onchange="changeWs()">
    <script>
        const defaultSecret = '';
        const defaultColors = '#FCA5A5,#FCD34D,#6EE7B7';

        document.getElementById('font-size').value = localStorage.getItem("font-size") || '40';
        document.getElementById('duration').value = localStorage.getItem("duration") || '10';
        document.getElementById('colors').value = localStorage.getItem("colors") || defaultColors;
        document.getElementById('secret').value = localStorage.getItem("secret") || defaultSecret;

        const chan = new BroadcastChannel("danmaku");
        chan.addEventListener('message', e => {
            const msg = e.data;
            if (msg.cmd == 'sync') {
                updateSetting();
            }
        });
        function showDanmaku(text, sender) {
            chan.postMessage({ cmd: 'text', text, sender });
        }
        function updateSetting() {
            const fontSize = +document.getElementById('font-size').value;
            const duration = +document.getElementById('duration').value;
            const colors = document.getElementById('colors').value;
            const secret = document.getElementById('secret').value;
            localStorage.setItem("font-size", fontSize);
            localStorage.setItem("duration", duration);
            localStorage.setItem("colors", colors);
            localStorage.setItem("secret", secret == defaultSecret ? "" : secret);
            chan.postMessage({ cmd: 'setting', fontSize, duration, colors });
        }
        function changeWs() {
            updateSetting();
            try { ws && ws.close(); } catch { }
            if (!ws && !retrying) connect();
        }
        updateSetting();


        function status(text) {
            document.getElementById('status').textContent = text;
        }
        let retrying = false;
        let ws = null;
        function connect() {
            retrying = false;
            try {
                ws = new WebSocket(document.getElementById('secret').value);
            } catch {
                status("Bad URL");
                return;
            }
            status("Connecting...");
            ws.onopen = (e) => {
                status("OK");
            };
            ws.onclose = (e) => {
                status("Closed...");
                ws = null;
                retrying = true;
                setTimeout(connect, 2000);
            };
            ws.onmessage = (e) => {
                if (typeof e.data == 'string') {
                    const msg = JSON.parse(e.data);
                    console.info(msg);
                    if (!msg || !msg.data || !msg.data.messageChain) return;
                    var textmsg = msg.data.messageChain
                        .map(x => {
                            if (x.type == 'Plain') return x.text;
                            if (x.type == 'Face') return `[${x.name}]`
                        })
                        .filter(x => x)
                        .join('');
                    if (textmsg.length > 0 && textmsg.length < 50 && !textmsg.match(/^\s+$/)) {
                        console.info("Msg Text: ", textmsg);
                        showDanmaku(textmsg, msg.data.sender);
                    }
                }
            };
        }


        connect();
    </script>
</body>
</html>
